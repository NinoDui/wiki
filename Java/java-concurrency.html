<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Java-Concurrency - Learning Notes of NinoDui</title>
    <meta name="keywords" content="Java, Python, MapReduce, Spark, AWS"/>
    <meta name="description" content="An ample-oriented collection of learning pieces."/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/wiki/">Home</a>&nbsp;&#187;&nbsp;<a href="/wiki/#Java">Java</a>&nbsp;&#187;&nbsp;Java-Concurrency
    <span class="updated">Page Updated&nbsp;
      2018-05-04 11:13
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Java-Concurrency</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#concurrency">Concurrency</a><ul>
<li><a href="#processes-and-threads">Processes and Threads</a><ul>
<li><a href="#processes">Processes</a></li>
<li><a href="#threads">Threads</a></li>
</ul>
</li>
<li><a href="#thread-objects">Thread Objects</a><ul>
<li><a href="#defining-and-starting-a-thread">Defining and Starting a Thread</a></li>
<li><a href="#pausing-execution-with-sleep">Pausing Execution with Sleep</a></li>
<li><a href="#interrupts">Interrupts</a><ul>
<li><a href="#supporting-interruption">Supporting Interruption</a></li>
<li><a href="#the-interrupt-status-flag">The Interrupt Status Flag</a></li>
</ul>
</li>
<li><a href="#joins">Joins</a></li>
</ul>
</li>
<li><a href="#synchronization">Synchronization</a><ul>
<li><a href="#thread-interference">Thread Interference</a></li>
<li><a href="#memory-consistency-errors">Memory Consistency Errors</a></li>
<li><a href="#synchronized-methods">Synchronized Methods</a></li>
<li><a href="#intrinsic-locks-and-synchronization">Intrinsic Locks and Synchronization</a></li>
<li><a href="#atomic-access">Atomic Access</a></li>
</ul>
</li>
<li><a href="#liveness">Liveness</a><ul>
<li><a href="#deadlock">Deadlock</a></li>
<li><a href="#starvation-and-livelock">Starvation and Livelock</a></li>
</ul>
</li>
<li><a href="#guarded-blocks">Guarded Blocks</a><ul>
<li><a href="#example-producer-and-consumer-model">Example - Producer and Consumer Model</a></li>
</ul>
</li>
<li><a href="#immutable-objects">Immutable Objects</a><ul>
<li><a href="#a-strategy-for-defining-immutable-objects">A Strategy for Defining Immutable Objects</a></li>
</ul>
</li>
<li><a href="#high-level-concurrency-objects">High Level Concurrency Objects</a><ul>
<li><a href="#lock-objects">Lock Objects</a></li>
</ul>
</li>
<li><a href="#executors">Executors</a><ul>
<li><a href="#executor-interfaces">Executor Interfaces</a><ul>
<li><a href="#executor">Executor</a></li>
<li><a href="#executorservice">ExecutorService</a></li>
<li><a href="#scheduledexecutorservice">ScheduledExecutorService</a></li>
</ul>
</li>
<li><a href="#thread-pools">Thread Pools</a><ul>
<li><a href="#_1"></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="concurrency">Concurrency</h1>
<h2 id="processes-and-threads">Processes and Threads</h2>
<blockquote>
<p>In the Java programming language, concurrent programming is mostly concerned with <strong>threads</strong>.</p>
</blockquote>
<h3 id="processes">Processes</h3>
<p>A process generally has a complete, private set of basic run-time resources; <strong>each process has its own memory space</strong>.</p>
<p>Processes are often seen as synonymous with programs or applications. However, what the user sees as a single application may in fact be a set of cooperating processes.</p>
<p><em>Inter Process Communication (IPC)</em> resources, such as pipes and sockets, used not just for <strong>communication between processes</strong> on the same/different system.</p>
<h3 id="threads">Threads</h3>
<p><em>lightweight processes</em>, both processes and threads provide an execution environment.</p>
<p>Threads exist within a process â€” every process has at least one. Threads share the process's resources, including memory and open files.</p>
<h2 id="thread-objects">Thread Objects</h2>
<p>Each thread is associated with an instance of the class <code>Thread</code>.</p>
<p>There are two basic strategies for using Thread objects to create a concurrent application:<br />
-   directly control thread creation and management, simply instantiate <code>Thread</code> each time the application needs to initiate an asynchronous task.<br />
-   abstract thread management from the rest of your application, pass the application's tasks to an <em>executor</em>. (High level)</p>
<h3 id="defining-and-starting-a-thread">Defining and Starting a Thread</h3>
<p>An application that creates an instance of <code>Thread</code> must provide the code that will <code>run</code> in that thread, via two ways:<br />
-   Object implements <code>Runnable</code>, passed to the <code>Thread</code> constructor. (<strong>More General</strong>)<br />
-   Subclass <code>Thread</code><br />
and then invoke <code>Thread.start</code></p>
<h3 id="pausing-execution-with-sleep">Pausing Execution with Sleep</h3>
<p><code>Thread.sleep</code> causes the current thread to suspend execution for a specified period. This is an efficient means of <strong>making processor time available</strong> to the other threads of an application or other applications that might be running on a computer system.</p>
<h3 id="interrupts">Interrupts</h3>
<p>An <em>interrupt</em> is an <strong>indication</strong> to a thread that it should stop what it is doing and do something else. A thread sends an interrupt by invoking <code>interrupt</code> on the Thread object for <strong>the thread to be interrupted</strong>.</p>
<h4 id="supporting-interruption">Supporting Interruption</h4>
<p>Many methods that throw <code>InterruptedException</code>, such as <code>sleep</code>, are designed to <strong>cancel their current operation and return immediately</strong> when an interrupt is received.</p>
<div class="hlcode"><pre><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">try</span> <span class="p">{</span>
        <span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
    <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>


<p>If a thread goes a long time without invoking a method that throws <code>InterruptedException</code>, it must <strong>periodically invoke <code>Thread.interrupted</code></strong>, which returns true if an interrupt has been received.</p>
<div class="hlcode"><pre><span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<h4 id="the-interrupt-status-flag">The Interrupt Status Flag</h4>
<p>The interrupt mechanism is implemented using an internal flag known as the <em>interrupt status</em>.<br />
-   <code>Thread.interrupt</code> sets this flag.<br />
-   static method <code>Thread.interrupted</code>, which thread checks for an interrupt by invoking, interrupt status is <strong>cleared</strong>.<br />
-   non-static <code>isInterrupted</code> method, used by one thread to query the interrupt status of another, does not change the interrupt status flag.<br />
-   <strong>any method</strong> that exits by throwing an <code>InterruptedException</code> clears interrupt status when it does so</p>
<h3 id="joins">Joins</h3>
<p>The <code>join</code> method allows one thread to <strong>wait for the completion of another</strong>.</p>
<p>Like <code>sleep</code>, <code>join</code> responds to an interrupt by exiting with an InterruptedException.</p>
<h2 id="synchronization">Synchronization</h2>
<h3 id="thread-interference">Thread Interference</h3>
<p>Interference happens when two operations, running in different threads, but acting on the same data, <em>interleave</em>. This means that the two operations consist of multiple steps, and the sequences of steps overlap.</p>
<h3 id="memory-consistency-errors">Memory Consistency Errors</h3>
<p><em>Memory consistency errors</em> occur when different threads have inconsistent views of what should be the same data. The key to avoiding memory consistency errors is understanding the <strong>happens-before</strong> relationship. This relationship is simply a guarantee that memory writes by one specific statement are visible to another specific statement.</p>
<p>A list of actions that create happens-before relationships (<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/package-summary.html#MemoryVisibility">Summary page of the <code>java.util.concurrent</code> package</a>)</p>
<blockquote>
<p>The results of a write by one thread are guaranteed to be visible to a read by another thread only if the write operation <strong>happens-before</strong> the read operation.</p>
</blockquote>
<ol>
<li>The <code>synchronized</code> and <code>volatile</code> constructs, as well as the <code>Thread.start()</code> and <code>Thread.join()</code> methods, can form happens-before relationships.</li>
<li>Each action in a thread happens-before every action in that thread that comes later in the program's order.</li>
<li>An unlock (<code>synchronized</code> block or method exit) of a monitor happens-before every subsequent lock (<code>synchronized</code> block or method entry) of that same monitor. And because the happens-before relation is transitive, all actions of a thread prior to unlocking happen-before all actions subsequent to any thread locking that monitor.</li>
<li>A write to a <code>volatile</code> field happens-before every subsequent read of that same field. Writes and reads of <code>volatile</code> fields have <strong>similar memory consistency effects</strong> as entering and exiting monitors, but <strong>do not entail mutual exclusion locking</strong>.</li>
<li>A call to start on a thread happens-before any action in the started thread.</li>
<li>All actions in a thread happen-before any other thread successfully returns from a <code>join</code> on that thread.</li>
</ol>
<p>(For High Level <em>Happen-before</em>, please refer to the link.)</p>
<h3 id="synchronized-methods">Synchronized Methods</h3>
<p>Two basic synchronization idioms:<br />
1. synchronized methods<br />
2. synchronized statements (more complex)</p>
<p>When one thread is executing a synchronized method for an object, all other threads that invoke synchronized methods for the same object block (suspend execution) until the first thread is done with the object. When a synchronized method exits, it automatically establishes a happens-before relationship with any subsequent invocation of a synchronized method for the same object.</p>
<p>Constructors cannot be synchronized. <code>final</code> fields are important exception, which cannot be modified after the object is constructed, can be safely read through non-synchronized methods, once the object is constructed.</p>
<h3 id="intrinsic-locks-and-synchronization">Intrinsic Locks and Synchronization</h3>
<p>Synchronization is built around an internal entity known as the <code>intrinsic lock</code> or <code>monitor lock</code>. When a thread invokes a synchronized method, it automatically acquires the intrinsic lock for that method's object and releases it when the method returns. The lock release occurs even if the return was caused by an uncaught exception. When a static synchronized method is invoked, the thread acquires the intrinsic lock for the <code>Class</code> object associated with the class. Thus access to class's static fields is controlled by a lock that's distinct from the lock for any instance of the class.</p>
<p>Synchronized statements must <strong>specify the object that provides the intrinsic lock</strong>.</p>
<div class="hlcode"><pre><span class="n">public</span> <span class="kt">void</span> <span class="nf">addName</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">synchronized</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lastName</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
        <span class="n">nameCount</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">nameList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>A thread cannot acquire a lock owned by another thread.</p>
<h3 id="atomic-access">Atomic Access</h3>
<p>An <em>atomic</em> action is one that effectively happens all at once.</p>
<ul>
<li>Reads and writes are atomic for reference variables and for most primitive variables (all types except <code>long</code> and <code>double</code>).</li>
<li>Reads and writes are atomic for all variables declared volatile (including long and double variables).</li>
</ul>
<h2 id="liveness">Liveness</h2>
<p>A concurrent application's ability to execute in a timely manner is known as its <strong>liveness</strong>.</p>
<h3 id="deadlock">Deadlock</h3>
<p>Deadlock describes a situation where two or more threads are blocked forever, <strong>waiting for each other</strong>.</p>
<h3 id="starvation-and-livelock">Starvation and Livelock</h3>
<p><em>Starvation</em> describes a situation where <strong>a thread is unable to gain regular access to shared resources and is unable to make progress</strong>. This happens when shared resources are made unavailable for long periods by "greedy" threads.</p>
<p>A thread often acts in response to the action of another thread. If the other thread's action is also a response to the action of another thread, then <em>livelock</em> may result. As with deadlock, <em>livelocked</em> threads are unable to make further progress.</p>
<h2 id="guarded-blocks">Guarded Blocks</h2>
<p><em>Guarded block</em>, a block begins by polling a condition that must be true before the block can proceed.</p>
<p>Waiting for a variable as a signal is wasteful, since it executes continuously waiting. A more efficient guard invokes <code>Object.wait</code> to <strong>suspend the current thread</strong>. The invocation of <code>wait</code> does not return until <strong>another thread has issued a notification</strong> that some special event may have occurred.</p>
<div class="hlcode"><pre><span class="n">public</span> <span class="n">synchronized</span> <span class="kt">void</span> <span class="nf">guardedJoy</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">joy</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">try</span> <span class="p">{</span>
            <span class="n">wait</span><span class="p">();</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;Done!&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>Reason why the method is <code>synchronized</code>: Invoking <code>wait</code> inside a synchronized method is a simple way to <strong>acquire the intrinsic lock</strong>. When wait is invoked, the thread releases the lock and suspends execution. At some future time, <strong>another thread will acquire the same lock</strong> and invoke <code>Object.notifyAll</code>, informing all threads waiting on that lock that something important has happened</p>
<div class="hlcode"><pre><span class="n">public</span> <span class="n">synchronized</span> <span class="nf">notifyJoy</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">joy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">notifyAll</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<p>Some time after the second thread has released the lock, the first thread reacquires the lock and <strong>resumes by returning from the invocation of wait</strong>.</p>
<h3 id="example-producer-and-consumer-model">Example - Producer and Consumer Model</h3>
<div class="hlcode"><pre><span class="c1">// Data model</span>
<span class="n">public</span> <span class="k">class</span> <span class="n">Drop</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">String</span> <span class="n">message</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">boolean</span> <span class="n">isEmpty</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">String</span> <span class="n">take</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">try</span> <span class="p">{</span>
                <span class="k">wait</span><span class="p">();</span>
            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">isEmpty</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
        <span class="n">notifyAll</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">message</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="n">synchronized</span> <span class="k">void</span> <span class="n">put</span><span class="p">(</span><span class="n">String</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">try</span> <span class="p">{</span>
                <span class="k">wait</span><span class="p">();</span>
            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="n">isEmpty</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
        <span class="n">notifyAll</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Producer</span>
<span class="kn">import</span> <span class="nn">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">Random</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">com</span><span class="p">.</span><span class="n">amazon</span><span class="p">.</span><span class="n">ayxu</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">RandomGenerator</span><span class="p">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="n">Producer</span> <span class="n">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">Drop</span> <span class="n">drop</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">Producer</span><span class="p">(</span><span class="n">Drop</span> <span class="n">drop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">drop</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="n">Override</span>
    <span class="n">public</span> <span class="k">void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">String</span><span class="p">[]</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="p">[</span><span class="mh">4</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RandomGenerator</span><span class="p">.</span><span class="n">fakeString</span><span class="p">(</span><span class="mh">4</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">drop</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="n">try</span> <span class="p">{</span>
                <span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mh">5000</span><span class="p">));</span>
            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="n">drop</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;Done!&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Consumer</span>
<span class="c1">// import java.util.Random;</span>

<span class="n">public</span> <span class="k">class</span> <span class="n">Consumer</span> <span class="n">implements</span> <span class="n">Runnable</span> <span class="p">{</span>

    <span class="n">private</span> <span class="n">Drop</span> <span class="n">drop</span><span class="p">;</span>

    <span class="n">public</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">Drop</span> <span class="n">drop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">drop</span> <span class="o">=</span> <span class="n">drop</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="n">Override</span>
    <span class="n">public</span> <span class="k">void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="n">drop</span><span class="p">.</span><span class="n">take</span><span class="p">();</span> <span class="o">!</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">equals</span><span class="p">(</span><span class="s">&quot;Done!&quot;</span><span class="p">));</span> <span class="n">message</span> <span class="o">=</span> <span class="n">drop</span><span class="p">.</span><span class="n">take</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;Message Received: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
            <span class="n">try</span> <span class="p">{</span>
                <span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mh">5000</span><span class="p">));</span>
            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Main</span>
<span class="n">public</span> <span class="k">class</span> <span class="n">ProducerConsumerExample</span> <span class="p">{</span>

    <span class="n">Drop</span> <span class="n">drop</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Drop</span><span class="p">();</span>

    <span class="n">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Drop</span> <span class="n">drop</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Drop</span><span class="p">();</span>
        <span class="p">(</span><span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Producer</span><span class="p">(</span><span class="n">drop</span><span class="p">))).</span><span class="n">start</span><span class="p">();</span>
        <span class="p">(</span><span class="k">new</span> <span class="n">Thread</span><span class="p">(</span><span class="k">new</span> <span class="n">Consumer</span><span class="p">(</span><span class="n">drop</span><span class="p">))).</span><span class="n">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="immutable-objects">Immutable Objects</h2>
<p>An object is considered <em>immutable</em> if <strong>its state cannot change after it is constructed</strong>.</p>
<h3 id="a-strategy-for-defining-immutable-objects">A Strategy for Defining Immutable Objects</h3>
<p>Several Strategies:</p>
<ol>
<li>Don't provide "<code>setter</code>" methods â€” methods that modify fields or objects referred to by fields.</li>
<li>Make all fields final and private.</li>
<li>Don't allow subclasses to override methods. The simplest way to do this is to declare the class as final. A more sophisticated approach is to make the constructor private and construct instances in factory methods.</li>
<li>If the instance fields include references to mutable objects, don't allow those objects to be changed:<ul>
<li>Don't provide methods that modify the mutable objects.</li>
<li>Don't share references to the mutable objects. Never store references to external, mutable objects passed to the constructor; if necessary, create copies, and store references to the copies. Similarly, create copies of your internal mutable objects when necessary to avoid returning the originals in your methods.</li>
</ul>
</li>
</ol>
<h2 id="high-level-concurrency-objects">High Level Concurrency Objects</h2>
<h3 id="lock-objects">Lock Objects</h3>
<p>As with implicit locks, only <strong>one thread</strong> can own a <code>Lock</code> object at a time. <code>Lock</code> objects also support a <code>wait/notify</code> mechanism, through their associated <code>Condition</code> objects.</p>
<div class="hlcode"><pre><span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">Random</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">concurrent</span><span class="p">.</span><span class="n">locks</span><span class="p">.</span><span class="n">Lock</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">concurrent</span><span class="p">.</span><span class="n">locks</span><span class="p">.</span><span class="n">ReentrantLock</span><span class="p">;</span>

<span class="n">public</span> <span class="n">class</span> <span class="n">SafeLock</span> <span class="p">{</span>
    <span class="k">static</span> <span class="n">class</span> <span class="n">Friend</span> <span class="p">{</span>
        <span class="n">private</span> <span class="n">final</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>
        <span class="n">private</span> <span class="n">final</span> <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ReentrantLock</span><span class="p">();</span>

        <span class="n">public</span> <span class="nf">Friend</span><span class="p">(</span><span class="n">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">this</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">this</span><span class="p">.</span><span class="n">name</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">boolean</span> <span class="nf">impendingBow</span><span class="p">(</span><span class="n">Friend</span> <span class="n">bower</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">boolean</span> <span class="n">myLock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">boolean</span> <span class="n">yourLock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="n">try</span> <span class="p">{</span>
                <span class="n">myLock</span> <span class="o">=</span> <span class="n">lock</span><span class="p">.</span><span class="n">tryLock</span><span class="p">();</span>
                <span class="n">yourLock</span> <span class="o">=</span> <span class="n">bower</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">tryLock</span><span class="p">();</span>
            <span class="p">}</span> <span class="n">finally</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">myLock</span> <span class="o">&amp;&amp;</span> <span class="n">yourLock</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">myLock</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">yourLock</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">bower</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">myLock</span> <span class="o">&amp;&amp;</span> <span class="n">yourLock</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="kt">void</span> <span class="nf">bow</span><span class="p">(</span><span class="n">Friend</span> <span class="n">bower</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">impendingBow</span><span class="p">(</span><span class="n">bower</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">try</span> <span class="p">{</span>
                    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;%s: %s has bowed to me!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">bower</span><span class="p">.</span><span class="n">getName</span><span class="p">());</span>
                    <span class="n">bower</span><span class="p">.</span><span class="n">bowBack</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
                <span class="p">}</span> <span class="n">finally</span> <span class="p">{</span>
                    <span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                    <span class="n">bower</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;%s: %s started to bow to me, but saw that I was already bowing to him.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">bower</span><span class="p">.</span><span class="n">getName</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="kt">void</span> <span class="nf">bowBack</span><span class="p">(</span><span class="n">Friend</span> <span class="n">bower</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;%s: %s has bowed back to me!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">bower</span><span class="p">.</span><span class="n">getName</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="n">class</span> <span class="n">BowLoop</span> <span class="n">implements</span> <span class="n">Runnable</span> <span class="p">{</span>
        <span class="n">private</span> <span class="n">Friend</span> <span class="n">bower</span><span class="p">;</span>
        <span class="n">private</span> <span class="n">Friend</span> <span class="n">bowee</span><span class="p">;</span>

        <span class="n">public</span> <span class="nf">BowLoop</span><span class="p">(</span><span class="n">Friend</span> <span class="n">bower</span><span class="p">,</span> <span class="n">Friend</span> <span class="n">bowee</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">this</span><span class="p">.</span><span class="n">bowee</span> <span class="o">=</span> <span class="n">bowee</span><span class="p">;</span>
            <span class="n">this</span><span class="p">.</span><span class="n">bower</span> <span class="o">=</span> <span class="n">bower</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Random</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
                <span class="n">try</span> <span class="p">{</span>
                    <span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
                <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{}</span>
                <span class="n">bowee</span><span class="p">.</span><span class="n">bow</span><span class="p">(</span><span class="n">bower</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">final</span> <span class="n">Friend</span> <span class="n">a</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Friend</span><span class="p">(</span><span class="s">&quot;A&quot;</span><span class="p">);</span>
        <span class="n">final</span> <span class="n">Friend</span> <span class="n">b</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Friend</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">);</span>
        <span class="n">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">new</span> <span class="n">BowLoop</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)).</span><span class="n">start</span><span class="p">();</span>
        <span class="n">new</span> <span class="nf">Thread</span><span class="p">(</span><span class="n">new</span> <span class="n">BowLoop</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)).</span><span class="n">start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="executors">Executors</h2>
<p>Objects that encapsulate functions to separate thread management and creation from the rest of the application are known as <em>executors</em>.</p>
<h3 id="executor-interfaces">Executor Interfaces</h3>
<p>In <code>java.util.concurrent</code> defines <strong>three</strong> executor interfaces:<br />
- <code>Executor</code>, a simple interface that supports launching new tasks.<br />
- <code>ExecutorService</code>, a subinterface of <code>Executor</code>, which adds features that help manage the lifecycle, both of the individual tasks and of the executor itself.<br />
- <code>ScheduledExecutorService</code>, a subinterface of ExecutorService, supports future and/or periodic execution of tasks.</p>
<h4 id="executor">Executor</h4>
<div class="hlcode"><pre><span class="o">(</span><span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
</pre></div>


<p>equals to</p>
<div class="hlcode"><pre><span class="n">e</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
</pre></div>


<h4 id="executorservice">ExecutorService</h4>
<p>The <code>ExecutorService</code> interface supplements <code>execute</code> with a similar, but more versatile <code>submit</code> method, which<br />
- accepts <code>Runnable</code> (like <code>execute</code> in <code>Executor</code>)<br />
- accepts <code>Callable</code> (allow a task to return a value)<br />
- returns a <code>Future</code> Object (used to retrieve the <code>Callable</code> return value and to manage the status of both <code>Callable</code> and <code>Runnable</code> tasks.)<br />
- provides methods for submitting <strong>large collections</strong> of <code>Callable</code> objects<br />
- provides a number of methods for managing the <strong>shutdown of the <code>executor</code></strong></p>
<h4 id="scheduledexecutorservice">ScheduledExecutorService</h4>
<p>The <code>ScheduledExecutorService</code> interface<br />
- supplements the methods of its parent ExecutorService with <code>schedule</code>, which executes a <code>Runnable</code> or <code>Callable</code> task <strong>after a specified delay</strong>.<br />
- defines <code>scheduleAtFixedRate</code> and <code>scheduleWithFixedDelay</code>, which executes specified tasks repeatedly, at defined intervals.</p>
<h3 id="thread-pools">Thread Pools</h3>
<p>A simple way to create an executor that uses a fixed thread pool is to invoke the <code>newFixedThreadPoo</code>l factory method in <code>java.util.concurrent.Executors</code> This class also provides the following factory methods:<br />
1. The <code>newCachedThreadPool</code> method creates an executor with an expandable thread pool. This executor is suitable for applications that launch many short-lived tasks.<br />
2. The <code>newSingleThreadExecutor</code> method creates an executor that <strong>executes a single task at a time</strong>.<br />
3. Several factory methods are <code>ScheduledExecutorService</code> versions of the above executors.</p>
<h4 id="_1"></h4>
  <div class="relation">
    <h2>Related</h2>
    <ul>
    
    <li><a href="/wiki/Java/idea-efficiency.html">IDEA-Efficiency</a></li>
    
    </ul>
  </div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright Â© 2018 NinoDui.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2018-05-18 17:04:51</p>
      </span>
    </div>

    
    
  </body>
</html>